<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saving and restoring simulation state • individual</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Saving and restoring simulation state">
<meta property="og:description" content="individual">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">individual</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.15</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/API.html">API</a>
    </li>
    <li>
      <a href="../articles/Changing_Populations.html">Changing population</a>
    </li>
    <li>
      <a href="../articles/Checkpoint.html">Saving and restoring simulation state</a>
    </li>
    <li>
      <a href="../articles/Contributing.html">Contributing</a>
    </li>
    <li>
      <a href="../articles/Performance.html">Performance</a>
    </li>
    <li>
      <a href="../articles/Tutorial.html">Tutorial</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/individual/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Saving and restoring simulation state</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/individual/blob/HEAD/vignettes/Checkpoint.Rmd" class="external-link"><code>vignettes/Checkpoint.Rmd</code></a></small>
      <div class="hidden name"><code>Checkpoint.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="intro">Introduction<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>When modeling the impact of an intervention on a disease, it is
common to have a first simulation phase where the intervention is
disabled to achieve steady-state, followed by a second phase during
which the intervention is applied. Often, we want to run the second
phase many times over, varying the intervention parameters. Simulating
the first phase every time is unnecessary and wasteful, since it isn’t
affected by the intervention parameters.</p>
<p>Individual allows the user to run a simulation for a number of time
steps, save the state of the simulation and resume it multiple times,
with different parameters each time. This way, the initial phase before
the intervention only needs to be simulated once.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>The typical way to use this feature is to define a simulation
function which creates all the relevant simulation data and then calls
<code>simulation_loop</code>. The function we define takes in an
optional <code>state</code> parameter that is passed through to
<code>simulation_loop</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">timesteps</span>, <span class="va">state</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">health</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">health</span>, <span class="st">"S"</span>, <span class="st">"I"</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">health</span><span class="op">)</span>,</span>
<span>    processes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">process</span><span class="op">)</span>,</span>
<span>    timesteps <span class="op">=</span> <span class="va">timesteps</span>,</span>
<span>    state <span class="op">=</span> <span class="va">state</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The simulation can be run a first time, for a given number of steps.
It returns a <em>state object</em>, which captures the internal state of
all variables and events, the state of the random number generator and
the number of time steps that were simulated.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the simulation is resumed with a larger number of time
steps, passing in the state object as an argument. The
<code>timesteps</code> argument refers to the total number of time
steps, including both the original simulation run and the new one. In
this case, <code>run_simulation</code> will only simulate 50 extra
steps. Before running the actual simulation,
<code>simulation_loop</code> will reload the simulation state from its
argument, overwriting any values we had set when initializing the
variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">run_simulation</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">100</span>, state <span class="op">=</span> <span class="va">state</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Practical example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>To demonstrate the checkpoint and restore functionality of individual
in a practical setting, we will use a SIRS model with a vaccination
intervention. Our aim is to compare the impact of the vaccination
campaign, given different vaccine efficacy scenarios.</p>
<p>Individuals in the simulation move from being susceptible (S) to
infectious (I) to recovered (R) and back to susceptible, after their
natural immunity wanes off. Out of the entire population <code>N</code>,
only <code>I0</code> individuals are initially infectios, and the rest
are susceptible. Orthogonally, an individual can either be vaccinated
(Y) or not (N). The vaccination and the immunity it confers never wanes
off. All individuals are initially unvaccinated.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_variables</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">I0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">health_states_t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="va">N</span><span class="op">)</span></span>
<span>  <span class="va">health_states_t0</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>,size <span class="op">=</span> <span class="va">I0</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"I"</span></span>
<span>  <span class="va">health</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="st">"I"</span>,<span class="st">"R"</span><span class="op">)</span>, initial_values <span class="op">=</span> <span class="va">health_states_t0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">vaccinated</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span>, initial_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"N"</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>health <span class="op">=</span> <span class="va">health</span>, vaccinated <span class="op">=</span> <span class="va">vaccinated</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A vaccinated individual has a reduced probability of becoming
infectious, as determined by the vaccine’s efficacy. The function below
creates the process to model infection. It samples from the susceptible
compartments, applying the different rates depending on the whether an
individual’s vaccinated status.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_infection_process</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">health</span>, <span class="va">vaccinated</span>, <span class="va">N</span>, <span class="va">beta</span>, <span class="va">vaccine_efficacy</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_size_of</span><span class="op">(</span><span class="st">"I"</span><span class="op">)</span></span>
<span>    <span class="va">foi</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span>
<span></span>
<span>    <span class="va">vaccinated_S</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"S"</span><span class="op">)</span><span class="op">$</span><span class="fu">and</span><span class="op">(</span><span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">non_vaccinated_S</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"S"</span><span class="op">)</span><span class="op">$</span><span class="fu">and</span><span class="op">(</span><span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">vaccinated_S</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>rate <span class="op">=</span> <span class="va">foi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">vaccine_efficacy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">non_vaccinated_S</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>rate <span class="op">=</span> <span class="va">foi</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">health</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"I"</span>, index <span class="op">=</span> <span class="va">vaccinated_S</span><span class="op">)</span></span>
<span>    <span class="va">health</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"I"</span>, index <span class="op">=</span> <span class="va">non_vaccinated_S</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Vaccination happens at fixed mass-vaccination event, according to a
pre-determined schedule defined by the <code>vaccination_times</code>
parameter. Each vaccination event affects a percentage of the
population, as determined by the <code>vaccination_coverage</code>
parameter. The coverage may vary from one instance to the next.</p>
<p>Because we intend on saving and restoring the simulation with various
vaccination schedules, we pass <code>restore = FALSE</code> to the
<code>Event</code> constructor. See the <a href="#events">Saving and
restoring events</a> section for details.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_vaccination_event</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vaccinated</span>, <span class="va">vaccination_times</span>, <span class="va">vaccination_coverage</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>restore <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="va">vaccination_times</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">e</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">vaccination_times</span> <span class="op">==</span> <span class="va">t</span><span class="op">)</span></span>
<span>    <span class="va">coverage</span> <span class="op">&lt;-</span> <span class="va">vaccination_coverage</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">targets</span> <span class="op">&lt;-</span> <span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="va">coverage</span><span class="op">)</span></span>
<span>    <span class="va">vaccinated</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"Y"</span>, <span class="va">targets</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">e</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will define our simulation as a function, taking the simulation
parameters as arguments. Any additional arguments to the function, as
denoted by <code>...</code>, will be passed on to
<code>simulation_loop</code>. This will allow us to pass the
<code>state</code> argument in. The function returns the simulation data
as well as the new saved state.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">steps</span>,</span>
<span>    <span class="va">N</span> <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>    <span class="va">I0</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    <span class="va">beta</span> <span class="op">=</span> <span class="fl">0.08</span>, <span class="co"># S -&gt; I</span></span>
<span>    <span class="va">gamma</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="co"># I -&gt; R</span></span>
<span>    <span class="va">xi</span> <span class="op">=</span> <span class="fl">0.02</span>, <span class="co"># R -&gt; S</span></span>
<span>    <span class="va">vaccination_times</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">vaccination_coverage</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vaccination_times</span><span class="op">)</span><span class="op">)</span>, <span class="co"># N -&gt; Y</span></span>
<span>    <span class="va">vaccine_efficacy</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu">make_variables</span><span class="op">(</span><span class="va">N</span>, <span class="va">I0</span><span class="op">)</span></span>
<span>  <span class="va">infection_process</span> <span class="op">&lt;-</span> <span class="fu">make_infection_process</span><span class="op">(</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">health</span>,</span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">vaccinated</span>,</span>
<span>    <span class="va">N</span>, <span class="va">beta</span>, <span class="va">vaccine_efficacy</span><span class="op">)</span></span>
<span>  <span class="va">recovery_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">variables</span><span class="op">$</span><span class="va">health</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="va">gamma</span><span class="op">)</span></span>
<span>  <span class="va">return_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">variables</span><span class="op">$</span><span class="va">health</span>, <span class="st">"R"</span>, <span class="st">"S"</span>, <span class="va">xi</span><span class="op">)</span></span>
<span>  <span class="va">vaccination_event</span> <span class="op">&lt;-</span> <span class="fu">make_vaccination_event</span><span class="op">(</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">vaccinated</span>, <span class="va">vaccination_times</span>, <span class="va">vaccination_coverage</span><span class="op">)</span></span>
<span>  <span class="va">renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="va">steps</span><span class="op">)</span></span>
<span>  <span class="va">health_render_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/categorical_count_renderer_process.html">categorical_count_renderer_process</a></span><span class="op">(</span></span>
<span>    renderer <span class="op">=</span> <span class="va">renderer</span>,</span>
<span>    variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">health</span>,</span>
<span>    categories <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">health</span><span class="op">$</span><span class="fu">get_categories</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">infection_process</span>,</span>
<span>    <span class="va">recovery_process</span>,</span>
<span>    <span class="va">return_process</span>,</span>
<span>    <span class="va">health_render_process</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">final_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="va">variables</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vaccination_event</span><span class="op">)</span>,</span>
<span>    processes <span class="op">=</span> <span class="va">processes</span>,</span>
<span>    timesteps <span class="op">=</span> <span class="va">steps</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>result <span class="op">=</span> <span class="va">renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>, state <span class="op">=</span> <span class="va">final_state</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will start by running and plotting our baseline simulation, with
the intervention disabled.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="va">colours</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>,<span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="st">"timestep"</span><span class="op">]</span>,</span>
<span>  y <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S_count"</span>,<span class="st">"I_count"</span>, <span class="st">"R_count"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Population count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>   pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We see that the simulation takes some time to settle from its initial
parameters to its steady-state conditions. We will now enable the
vaccine intervention, but only starting at a point after the simulation
has settled, for example at <code>t=500</code>, and every 250 steps
after that.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vaccination_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">500</span>,<span class="fl">1500</span>,<span class="fl">250</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, vaccination_times <span class="op">=</span> <span class="va">vaccination_times</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="va">colours</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>,<span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="st">"timestep"</span><span class="op">]</span>,</span>
<span>  y <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S_count"</span>,<span class="st">"I_count"</span>, <span class="st">"R_count"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">vaccination_times</span>, col <span class="op">=</span> <span class="st">"snow4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>   pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span>,</span>
<span>   cex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The simulation above clearly shows the effect of the vaccination
campaign, starting at <code>t=500</code>. However, it made the
optimistic assumption of a 100% vaccine efficacy. We wish to run the
simulation again but with varying levels of efficacy, in order the
compare its impact.</p>
<p>While we could run the code above many times over, each simulation
would repeat the first 499 timesteps, despite the result being identical
each time. Instead we start by running only these timesteps, and saving
the result. The details of the intervention (ie.
<code>vaccination_times</code> and <code>vaccine_efficacy</code>) are
irrelevant and can be omitted.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">499</span><span class="op">)</span></span></code></pre></div>
<p>From this initial result, we can resume the simulation, but using
different values of vaccine efficacy each time. We also include a
control simulation, in which no vaccination takes place. Each of these
simulation will skip the first 499 steps and only run the next 1001 time
steps.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine50</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span></span>
<span>  steps <span class="op">=</span> <span class="fl">1500</span>, vaccination_times <span class="op">=</span> <span class="va">vaccination_times</span>, vaccine_efficacy <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine80</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span></span>
<span>  steps <span class="op">=</span> <span class="fl">1500</span>, vaccination_times <span class="op">=</span> <span class="va">vaccination_times</span>, vaccine_efficacy <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine100</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span></span>
<span>  steps <span class="op">=</span> <span class="fl">1500</span>, vaccination_times <span class="op">=</span> <span class="va">vaccination_times</span>, vaccine_efficacy <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span></code></pre></div>
<p>Finally we aggregate and plot the results from all these simulations.
We also need to include the data from our initial run, which we will
plot the same colour as our control simulation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>, <span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span>, <span class="st">"seagreen3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pad initial out to ensure it has the same shape as other series.</span></span>
<span><span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine50</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine80</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine100</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">control</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Infected count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span>,</span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">vaccination_times</span>, col <span class="op">=</span> <span class="st">"snow4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"50%"</span>, <span class="st">"80%"</span>, <span class="st">"100%"</span><span class="op">)</span>,</span>
<span>   cex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="caveats">Caveats<a class="anchor" aria-label="anchor" href="#caveats"></a>
</h2>
<p>Saving and restoring the simulation state comes with a number of
caveats.</p>
<ul>
<li>All simulation state must be represented as objects managed by
individual. Any state maintained externally will not be saved nor
restored.</li>
<li>The state object’s structure is not stable and is expected to
change. One should not expect to serialize the state to disk and have it
work with future versions of the individual package.</li>
<li>The simulation must be re-created in an identical way. Variables and
events may not be added or removed, variable sizes must remain constant,
the list of categories in a <code>CategoricalVariable</code> cannot be
modified, etc. The order of variables and events passed to the
<code>run_simulation</code> function must remain stable.</li>
</ul>
<p>While parameters of the simulation can be changed between the initial
run and the subsequent runs (as demonstrated with the
<code>vaccine_efficacy</code> parameter above), in general you should
not modify parameters that would have been already had an impact on the
first part of the simulation. Doing so would produce results that can
only be produced through checkpoint and resume, and not as a single
simulation.</p>
<p>For example, in our SIRS model, it may be tempting to model a
time-varying parameter by running half of the simulation with one value
and then resuming it with a different value. While this would probably
work, it would be brittle and hard to compose. As more time-varying
parameters are introduced to the model, the simulation would need to be
saved and restored each time a value changes.</p>
<div class="section level3">
<h3 id="rng">Restoring random number generator state<a class="anchor" aria-label="anchor" href="#rng"></a>
</h3>
<p>By default resuming a simulation does not restore R’s random number
generator’s state. Every resumed run from the same saved state will be
independent and, if the model is stochastic, will produce different
results.</p>
<p>We can demonstrate that by running the baseline of our SIRS model
multiple times and plotting the results. All three runs start off from
the same state, inherited from our original model run, but quickly
diverge based on the outcome of random draws.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">499</span><span class="op">)</span></span>
<span><span class="va">run1</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">run2</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">run3</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span></span>
<span><span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run1</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run2</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run3</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Infected count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Sometimes this behaviour may not be desirable, and we would instead
like to restore the state of the random number generator exactly where
it was when we stopped the first part of the run. One example of this is
when checking that our model behaves the same whether or not it was
saved and resumed.</p>
<p>The code below show an attempt at running the model twice, once as a
continous run and once in a piecewise manner. We would hope that seeding
the random generator at the start of the simulation would be enough to
get identical results out of it. Unfortunately we don’t, because the
random number generator state’s at the intermediate point isn’t being
preserved.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">uninterrupted_run</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">499</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_final</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">piecewise_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">result</span>, <span class="va">piecewise_run_final</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">uninterrupted_run</span>, <span class="va">piecewise_run</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Component \"S_count\": Mean relative difference: 0.07121431"</span></span>
<span><span class="co">#&gt; [2] "Component \"I_count\": Mean relative difference: 0.2255931" </span></span>
<span><span class="co">#&gt; [3] "Component \"R_count\": Mean relative difference: 0.1328323"</span></span></code></pre></div>
<p>We can try to resume the simulation again, but this time set
<code>restore_random_state = TRUE</code> to enable restoring the
simulation state. This time we’ve successfully managed to reproduce the
data from our uninterrupted run.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piecewise_run_final</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span></span>
<span>  steps <span class="op">=</span> <span class="fl">1500</span>,</span>
<span>  state <span class="op">=</span> <span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">state</span>,</span>
<span>  restore_random_state <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">piecewise_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">result</span>, <span class="va">piecewise_run_final</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">uninterrupted_run</span>, <span class="va">piecewise_run</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Using <code>restore_random_state = TRUE</code> resets the global
random number generator’s state, which could have surprising and
undesirable side effects. It is generally useful in tests, but should be
used carefully elsewhere.</p>
</div>
<div class="section level3">
<h3 id="events">Saving and restoring events<a class="anchor" aria-label="anchor" href="#events"></a>
</h3>
<p>By default, the <code>Event</code> and <code>TargetedEvent</code>
classes save their schedule in the checkpoint and restore them when
loading from a previous simulation state. When restoring its schedule,
the event will clear its existing schedule and overwrite any pending
time steps with the schedule found in the saved state.</p>
<p>For example in the code below, the simulation is first initialized
with an event scheduled at <code>t=10</code> and is run for only 5
steps, hence the event does not yet trigger. On the second run, the
event is seemingly scheduled for <code>t=15</code>. However, by resuming
the simulation, the event’s schedule is overwritten with the saved
state, clearing the newly scheduled time. The event is triggered at
<code>t=10</code> only.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">5</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="fl">14</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Triggered at timestep"</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">30</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, state <span class="op">=</span> <span class="va">state</span><span class="op">)</span></span>
<span><span class="co">#&gt; Triggered at timestep 10</span></span></code></pre></div>
<p>Such a behaviour may prevent some modeling scenarios from being used
with the save and restore effectively. For example, in our prior SIRS
model, we wanted to be able to simulate historical data, where no
intervention took place, and then resume it with different intervention
parameters. If the vaccination event were to always restore its state
from the original run, we would not be able to set a new schedule on the
intervention runs.</p>
<p>This behaviour can be modified on a per-event basis by passing
<code>restore = FALSE</code> as an argument to the <code>Event</code>
constructor. In that case, the schedule from the original run is
ignored, and instead the schedule of the new run is only determined from
its new initialization.</p>
<p>In the modified example below, the event triggers at
<code>t=15</code> as intended. When restoring the simulation, we had
also schedules the event to trigger at <code>t=3</code>, but this never
happens as it is before the point where the simulation is restored.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">5</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>restore<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">index</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Triggered at timestep"</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">30</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, state <span class="op">=</span> <span class="va">state</span><span class="op">)</span></span>
<span><span class="co">#&gt; Triggered at timestep 15</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Giovanni Charles, Sean L. Wu, Peter Winskill, Paul Liétar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
